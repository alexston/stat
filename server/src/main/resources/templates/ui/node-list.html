<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>节点</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="/static/ui/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/static/ui/style/admin.css" media="all">
    <link rel="stylesheet" href="/static/assets/css/amazeui.min.css"/>
    <link rel="stylesheet" href="/static/assets/css/admin.css">
</head>
<body>

<div class="layui-fluid" style="background-color:#f2f2f2">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">地址</label>
                    <div class="layui-input-inline">
                        <input type="text" name="id" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">名称</label>
                    <div class="layui-input-inline">
                        <input type="text" name="author" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">标签</label>
                    <div class="layui-input-inline">
                        <input type="text" name="title" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-app-contlist-search">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="layui-card-body">
            <div style="padding-bottom: 10px;">
                <button class="layui-btn layuiadmin-btn-list" data-type="add">添加节点</button>
            </div>
            <div id="dataTable">
                <table class="layui-table layuiadmin-page-table" lay-skin="line">
                    <thead>
                    <tr>
                        <th><span style="white-space:nowrap">ID</span></th>
                        <th><span style="white-space:nowrap">名称</span></th>
                        <th><span style="white-space:nowrap">地址</span></th>
                        <th><span style="white-space:nowrap">状态</span></th>
                        <th><span style="white-space:nowrap">容器数量</span></th>
                        <th><span style="white-space:nowrap">资源</span></th>
                        <th><span style="white-space:nowrap">操作</span></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="node in nodes">
                        <td><a v-bind:lay-href="[ '/node/' + node.id ]"
                               v-bind:lay-text="['节点 ' + node.info.publicIp]">{{ node.displayId }}</a></td>
                        <td>{{ node.name }}</td>
                        <td>{{ node.info.publicIp }}</td>
                        <td><span v-bind:class="[ node.statusClass ]">{{ node.status }}</span></td>
                        <td>
                            <a v-bind:lay-href="[ '/node/' + node.id + '/container' ]"
                               v-bind:lay-text="[ node.info.publicIp + ' 的容器' ]">
                                {{ node.containers.running }}/{{ node.containers.total }}
                            </a>
                        </td>
                        <td>{{ node.info.resources.cpus }} CPU, {{ node.info.resources.memory }} 内存</td>
                        <td>
                            <button class="layui-btn layui-btn-primary layui-btn-sm"><i
                                    class="layui-icon layui-icon-edit"></i></button>
                            <button class="layui-btn layui-btn-primary layui-btn-sm"><i
                                    class="layui-icon layui-icon-delete"></i></button>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div>
                    <div id="laypage"></div>
                </div>
            </div>

        </div>
    </div>
</div>


<!--[if lt IE 9]>
<script src="/static/assets/jquery/1.11.1/jquery.min.js"></script>
<script src="/static/assets/2.8.3/modernizr.js"></script>
<script src="/static/assets/js/polyfill/rem.min.js"></script>
<script src="/static/assets/js/polyfill/respond.min.js"></script>
<script src="/static/assets/js/amazeui.legacy.js"></script>
<![endif]-->

<!--[if (gte IE 9)|!(IE)]><!-->
<script src="/static/assets/js/jquery.min.js"></script>
<script src="/static/assets/js/amazeui.min.js"></script>
<!--<![endif]-->
<script src="/static/assets/js/app.js"></script>

<!-- script begin -->
<script src="/static/assets/js/vue.min.js" type="text/javascript"></script>
<script src="/static/assets/js/vue-resource.min.js" type="text/javascript"></script>
<script src="/static/assets/js/common.js" type="text/javascript"></script>
<script src="/static/ui/layui/layui.js"></script>
<script>
var dataTable = new Vue({
	el : '#dataTable',
	data : {
		nodes: [],
		pageable: {},
		totalElements: 0,
		totalPages: 0
	},
	methods: {
		search: function(name, publicIp, label, page) {
			Vue.http.get('/api/node?page=' + page).then(function(ret) {
				dataTable.nodes = ret.body.content;
				dataTable.pageable = ret.body.pageable;
				dataTable.totalElements = ret.body.totalElements;
				dataTable.totalPages = ret.body.totalPages;
				$.each(dataTable.nodes, function(i, node) {
					if (node.id > '') {
						node.displayId = node.id.substring(0, 12);
					}
					if (node.status === 'online') {
						node.statusClass = 'am-badge am-badge-success';
					} else {
						node.statusClass = 'am-badge am-badge-danger';
					}
				});
			});
		},
		refresh: function() {
			$.each(dataTable.nodes, function(i, node) {
				if (node.id === null) {
					return;
				}
				Vue.http.get('/api/node/'+node.id).then(function(ret) {
					node.containers = ret.body.containers;
					node.status = ret.body.status;
					if (node.status == 'online') {
						node.statusClass = 'am-badge am-badge-success';
					} else {
						node.statusClass = 'am-badge am-badge-danger';
					}
				});
			});
		}
	}
});

$(document).ready(function () {
	var name = '';
	var publicIp = '';
	var label = '';
	dataTable.search(name, publicIp, label, 0);
	setInterval(function() {
		dataTable.refresh();
	}, 5000);
});

layui.config({
	base: '/static/ui/' //静态资源所在路径
}).extend({
	index: 'lib/index' //主入口模块
}).use(['index', 'contlist', 'table', 'laypage'], function(){
	var laypage = layui.laypage;
	laypage.render({
		elem: 'laypage',
		count: dataTable.totalElements,
		layout: ['count', 'prev', 'page', 'next'],
		jump: function(obj){
			dataTable.search('', '', '', obj.curr-1);
		}
	});
});

</script>
</body>
</html>
