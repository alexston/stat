<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>STAT HUB - 服务列表</title>
<link href="stylesheets/stat.css" rel="stylesheet" type="text/css" />
<script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
<script src="js/vue.min.js" type="text/javascript"></script>
<script src="js/vue-resource.min.js" type="text/javascript"></script>
<script src="js/common.js" type="text/javascript"></script>
</head>
<body>
	<div id="wrapper">
		<div id="header">
			<a href="/"><img src="images/stat.png" alt="Status" /></a>
			<p id="nodestatus">
				主机：<b>{{ hostname }}</b>
				CPU：{{ cpus }} 核
				磁盘：{{diskTotal }} 
				内存：{{ memoryTotal }}
			</p>
		</div>
		<div id="content">
			<div class="hidden" id="statusmessage">&nbsp;</div>
			<ul id="buttons" class="clr">
				<li id="restart_all">
					<a onclick="restartAll()" href="javascript:void(0)">&nbsp;</a>
				</li>
			</ul>
			<table cellspacing="0" id="servicetable">
				<tr>
					<th class="state">状态</th>
					<th class="name">服务名称</th>
					<th class="scale">计划进程数</th>
					<th class="count">实际进程数</th>
					<th class="action">操作</th>
				</tr>
				<tr v-for="service in services">
					<td class="status"><div v-bind:class="[ service.statusClass ]">{{ service.statusName }}</div></td>
					<td><a v-bind:href="[ 'service.html?name=' + service.name ]">{{ service.name }}</a></td>
					<td>{{ service.replicas }}</td>
					<td><a v-bind:href="[ 'instance.html?service=' + service.name ]">{{ service.ps }}</a></td>
					<td class="action">
						<ul>
							<li><a href="javascript:void(0)" v-on:click="restartService(service.name)">重新启动</a></li>
						</ul>
					</td>
				</tr>
			</table>
		</div>
		<br />
		<div class="push"></div>
	</div>

	<div id="footer" class="clr">
		<div class="left">
			<a href="/">STAT HUB</a> <span id="supervisor_version">#</span>
		</div>
		<div class="right">
			&amp;copy; 2006-<span id="copyright_date">#</span> <strong>lane.cn@gmail.com</strong>
		</div>
	</div>

	<script>
	var nodeStatus = new Vue({
		el : '#nodestatus',
		data : {
			hostname : null,
			cpus : null,
			diskTotal : null,
			memoryTotal : null
		},
		methods : {
			loadData : function() {
				// cpu count
				Vue.http.get('/api/v2/system/os').then(function(ret) {
					nodeStatus.cpus = ret.body.cpus;
				});
				// hostname
				Vue.http.get('/api/v2/system/hostname').then(function(ret) {
					nodeStatus.hostname = ret.bodyText;
				});
				// disk size
				Vue.http.get('/actuator/metrics/system.disk.total').then(function(ret) {
					nodeStatus.diskTotal = byteCountToDisplaySize(ret.body.measurements[0].value * 1024);
				});
				// memory size
				Vue.http.get('/api/v2/system/memory').then(function(ret) {
					nodeStatus.memoryTotal = byteCountToDisplaySize(ret.body.total);
				});
			}
		}
	});
	nodeStatus.loadData();

	var serviceStatus = new Vue({
		el : '#servicetable',
		data : {
			services : []
		},
		methods : {
			// load table data
			loadData : function() {
				var STATUS_NAMES = [ '警告', '停止', '正常', '错误' ];
				Vue.http.get('/api/v2/service').then(function(ret) {
					var services = ret.body;
					$.each(services, function(i, service) {
						service.replicas = service.deploy == null ? 0 : service.deploy.replicas;
						service.ps = 0;
						service.statusClass = '';
						service.statusName = '';
						Vue.http.get('/api/v2/service/' + service.name + '/instance').then(function(ps) {
							service.ps = ps.body.length;
							var statusCode = 0;
							if (service.replicas) {
								if (service.ps >= service.replicas) {
									statusCode = 2;
								} else if (service.replicas > service.ps && service.ps > 0) {
									statusCode = 0;
								} else if (service.ps == 0) {
									statusCode = 3;
								}
							} else {
								statusCode = 1;
							}
							service.statusClass = 'status' + statusCode;
							service.statusName = STATUS_NAMES[statusCode];
						});
					});
					serviceStatus.services = services;
				});
			},
			// on click 'restart' link
			restartService : function(serviceName) {
			    if (confirm('即将重启进程，需要继续吗？')) {
			        $.get('/api/v2/service/' + serviceName + '/instance', function(instances, status, xhr) {
			            var count = 0;
			            $.each(instances, function(i, instance) {
			                var url = '/api/v2/instance/' + instance.pid + '/_kill';
			                $.post(url, function(data, status) {
			                    count ++;
			                });
			            });
			            alert('已经发出重启指令');
			        });
			    }
			}
		}
	});
	$(document).ready(function () {
		serviceStatus.loadData();
		setInterval(function() {
			serviceStatus.loadData();
		}, 5000);
	});
	
	// click 'restart all' button
	function restartAll() {
	    if (confirm('即将重启所有进程，需要继续吗？')) {
	        $.get('/api/v2/instance', function(instances, status, xhr) {
	            var count = 0;
	            $.each(instances, function(i, instance) {
	                var url = '/api/v2/instance/' + instance.pid + '/_kill';
	                $.post(url, function(data, status) {
	                    count ++;
	                });
	            });
	            alert('已经发出重启指令');
	        });
	    }
	}
	</script>
</body>
</html>
